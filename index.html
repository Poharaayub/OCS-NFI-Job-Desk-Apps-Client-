<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Monitor - Compact M3</title>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
  :root {
    /* M3 2026 Terbaru - Blue Palette */
    --m3-primary: #005FAF; 
    --m3-on-primary: #ffffff;
    --m3-primary-container: #D1E4FF;
    --m3-on-primary-container: #001D36;
    
    --m3-surface: #F8F9FF;
    --m3-on-surface: #191C1E;
    --m3-surface-container: #F0F1F7;
    --m3-surface-container-high: #E2E2E9;
    
    --m3-outline-variant: #C3C7CF;

    /* Dynamic Status Colors M3 (Update: Authentic Green M3 for Done) */
    --status-done-bg: #C4EED0; /* M3 Green Container */
    --status-done-text: #06210E; /* M3 On Green Container */
    --status-pending-bg: #FFE08D;
    --status-pending-text: #241A00;
    --status-process-bg: #D1E4FF;
    --status-process-text: #001D36;
    --status-cancel-bg: #FFDAD6;
    --status-cancel-text: #410002;
  }

  /* Compact Tonal Variations */
  .m3-tonal-0 { --card-bg: #EFF1F8; }
  .m3-tonal-1 { --card-bg: #F5F0F0; }
  .m3-tonal-2 { --card-bg: #EDF2EA; }
  .m3-tonal-3 { --card-bg: #F8F1E7; }
  .m3-tonal-4 { --card-bg: #F1F0F5; }
  .m3-tonal-5 { --card-bg: #F0F4F4; }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body { 
    font-family: 'Roboto', sans-serif; 
    background-color: var(--m3-surface); 
    color: var(--m3-on-surface);
    margin: 0;
    padding-bottom: 16px;
    font-size: 13px;
    line-height: 1.4;
  }

  .header-controls {
    position: sticky;
    top: 0;
    background: rgba(248, 249, 255, 0.95);
    backdrop-filter: blur(12px);
    z-index: 10;
    padding: 10px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-bottom: 1px solid var(--m3-outline-variant);
  }

  .search-box {
    background: var(--m3-surface-container-high);
    border-radius: 12px;
    padding: 0 12px;
    height: 40px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .search-box input {
    background: transparent;
    border: none;
    outline: none;
    flex: 1;
    font-size: 14px;
    color: var(--m3-on-surface);
  }

  .filter-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .filter-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 10px;
    height: 36px;
    border-radius: 8px;
    background: var(--m3-surface-container);
  }

  .filter-item select, .filter-item input {
    border: none;
    outline: none;
    background: transparent;
    font-size: 12px;
    width: 100%;
    font-family: inherit;
  }

  .tasks-area {
    max-width: 600px;
    margin: 0 auto;
    padding: 12px;
  }

  .job-card {
    background: var(--card-bg, var(--m3-surface-container));
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: transform 0.1s ease;
  }

  .job-card:active { transform: scale(0.98); }

  .job-card.is-today {
    background: var(--m3-primary-container);
    box-shadow: 0 2px 8px rgba(0, 95, 175, 0.08);
  }

  .job-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
  }

  .task-title { 
    font-family: 'Google Sans', sans-serif;
    font-size: 15px;
    font-weight: 500; 
    margin: 0;
    color: var(--m3-on-surface);
    line-height: 1.2;
  }

  /* Status Tag Dynamic Styles */
  .status-tag {
    font-size: 10px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 100px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .status-selesai { background: var(--status-done-bg); color: var(--status-done-text); }
  .status-menunggu { background: var(--status-pending-bg); color: var(--status-pending-text); }
  .status-proses { background: var(--status-process-bg); color: var(--status-process-text); }
  .status-batal { background: var(--status-cancel-bg); color: var(--status-cancel-text); }
  .status-default { background: var(--m3-surface-container-high); color: var(--m3-on-surface); }

  .info-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    opacity: 0.75;
  }

  .info-chip { display: flex; align-items: center; gap: 4px; }

  .member-section {
    padding-top: 8px;
    border-top: 1px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12.5px;
  }

  .btn-doc {
    background: var(--m3-primary);
    color: var(--m3-on-primary);
    border: none;
    border-radius: 12px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .btn-doc:hover { opacity: 0.9; }

  .sheet-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.4); display: none; z-index: 100; 
  }

  .m3-sheet {
    position: fixed; bottom: -100%; left: 0; width: 100%; height: 90vh; 
    background: var(--m3-surface); border-top-left-radius: 24px; border-top-right-radius: 24px;
    z-index: 101; transition: bottom 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
  }

  .m3-sheet.active { bottom: 0; }

  .drag-handle { 
    height: 4px; width: 32px; background: var(--m3-outline-variant); 
    border-radius: 2px; margin: 12px auto; 
  }
  
  .sheet-header {
    padding: 0 12px 12px; display: flex; align-items: center; 
    border-bottom: 1px solid var(--m3-surface-container);
  }

  .loader-box { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; gap: 10px; }
  .spin { width: 32px; height: 32px; border: 3px solid var(--m3-surface-container); border-top: 3px solid var(--m3-primary); border-radius: 50%; animation: rot 1s linear infinite; }
  @keyframes rot { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header class="header-controls">
  <div class="search-box">
    <i data-lucide="search" size="16"></i>
    <input type="text" id="searchInput" placeholder="Cari member, tugas, PIC...">
  </div>

  <div class="filter-grid">
    <div class="filter-item">
      <i data-lucide="map-pin" size="14"></i>
      <select id="areaFilter"><option value="">Area</option></select>
    </div>
    <div class="filter-item">
      <i data-lucide="calendar" size="14"></i>
      <input type="date" id="dateFilter">
    </div>
  </div>
</header>

<main class="tasks-area">
  <div id="loader" class="loader-box">
    <div class="spin"></div>
    <span style="opacity: 0.6; font-size: 12px;">Memuat data...</span>
  </div>
  <div id="cardsList"></div>
</main>

<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="m3-sheet" id="docSheet">
  <div class="drag-handle"></div>
  <div class="sheet-header">
    <button style="background:none; border:none; padding:8px; cursor:pointer; display:flex; align-items:center;" onclick="goBack()">
      <i data-lucide="chevron-left" size="24"></i>
    </button>
    <h3 style="flex:1; margin:0 8px; font-size:16px; font-family:'Google Sans'; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="sheetTitle">Dokumen</h3>
    <a href="#" id="outLink" target="_blank" style="padding:8px; color:var(--m3-primary); display:flex; align-items:center;">
      <i data-lucide="external-link" size="20"></i>
    </a>
  </div>
  <iframe id="sheetFrame" style="flex:1; border:none; width:100%; background:#fff;"></iframe>
</div>

<script>
const DATA_SOURCE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSy72yhzMb2711VnnX-K1x6DG2-HNdlGRJfeORikr4x6ylI5ETjTaEjXzJ4KR0a632i65ZJpq667B-t/pub?output=csv";
let jobData = [];
let sheetActive = false;
const today = new Date().toISOString().split('T')[0];

function fixDate(val) {
  if(!val) return "";
  const pts = val.split(/[-/]/);
  if(pts.length === 3) {
    if(pts[0].length === 4) return `${pts[0]}-${pts[1].padStart(2,'0')}-${pts[2].padStart(2,'0')}`;
    return `${pts[2]}-${pts[1].padStart(2,'0')}-${pts[0].padStart(2,'0')}`;
  }
  return val;
}

function processData(raw) {
  const rows = raw.trim().split(/\r?\n/);
  const result = rows.slice(1).map(row => {
    const cols = [];
    let cur = "", q = false;
    for (let char of row) {
      if (char === '"') q = !q;
      else if (char === ',' && !q) { cols.push(cur.trim()); cur = ""; }
      else cur += char;
    }
    cols.push(cur.trim());
    return {
      tgl: fixDate(cols[0]),
      job: cols[1] || "Untitled",
      area: cols[2] || "-",
      member: cols[3] || "-",
      jam: cols[4] || "-",
      pic: cols[5] || "-",
      status: cols[6] || "Menunggu",
      link: (cols[7] || "").trim()
    };
  }).filter(r => r.tgl);
  return result.sort((a, b) => (a.tgl === today && b.tgl !== today) ? -1 : (a.tgl !== today && b.tgl === today) ? 1 : new Date(b.tgl) - new Date(a.tgl));
}

function getStatusInfo(status) {
  const s = status.toLowerCase();
  if (s.includes('selesai') || s === 'done') return { class: 'status-selesai', icon: 'check-circle' };
  if (s.includes('tunggu')) return { class: 'status-menunggu', icon: 'clock' };
  if (s.includes('proses')) return { class: 'status-proses', icon: 'play-circle' };
  if (s.includes('batal')) return { class: 'status-batal', icon: 'x-circle' };
  return { class: 'status-default', icon: 'info' };
}

function renderUI() {
  const list = document.getElementById("cardsList");
  const sQ = document.getElementById("searchInput").value.toLowerCase();
  const aF = document.getElementById("areaFilter").value;
  const dF = document.getElementById("dateFilter").value;
  
  const filtered = jobData.filter(j => 
    (aF ? j.area === aF : true) && (dF ? j.tgl === dF : true) &&
    (sQ ? (j.member.toLowerCase().includes(sQ) || j.job.toLowerCase().includes(sQ) || j.pic.toLowerCase().includes(sQ)) : true)
  );

  list.innerHTML = filtered.map((j, i) => {
    const isTod = j.tgl === today;
    const variant = `m3-tonal-${i % 6}`;
    const statusInfo = getStatusInfo(j.status);
    
    return `
      <div class="job-card ${variant} ${isTod ? 'is-today' : ''}">
        <div class="job-card-header">
          <h3 class="task-title">${j.job}</h3>
          <span class="status-tag ${statusInfo.class}"><i data-lucide="${statusInfo.icon}" size="12"></i> ${j.status}</span>
        </div>
        <div class="info-row">
          <div class="info-chip"><i data-lucide="calendar" size="12"></i><span>${isTod ? 'HARI INI' : j.tgl}</span></div>
          <div class="info-chip"><i data-lucide="clock" size="12"></i><span>${j.jam}</span></div>
          <div class="info-chip"><i data-lucide="navigation" size="12"></i><span>${j.area}</span></div>
        </div>
        <div class="member-section">
          <div style="font-weight:500;"><i data-lucide="users" size="14"></i> ${j.member}</div>
          <div style="font-size:10px; opacity:0.6">PIC: ${j.pic}</div>
        </div>
        ${j.link.startsWith('http') ? `<button class="btn-doc" onclick="openDoc('${j.link.replace(/'/g, "\\'")}','${j.job.replace(/'/g, "\\Source")}')"><i data-lucide="file-text" size="14"></i> Lihat Dokumentasi</button>` : ''}
      </div>
    `;
  }).join('');
  lucide.createIcons();
}

async function start() {
  try {
    const r = await fetch(`${DATA_SOURCE}&_=${Date.now()}`);
    const text = await r.text();
    jobData = processData(text);
    const sel = document.getElementById("areaFilter");
    [...new Set(jobData.map(d => d.area))].filter(x => x && x !== "-").sort().forEach(a => {
      const opt = document.createElement("option"); opt.value = a; opt.textContent = a;
      sel.appendChild(opt);
    });
    document.getElementById("loader").style.display = "none";
    renderUI();
  } catch (err) { document.getElementById("loader").innerHTML = "Gagal memuat data."; }
}

function openDoc(url, title) {
  sheetActive = true;
  document.getElementById('sheetTitle').innerText = title;
  document.getElementById('sheetFrame').src = url.replace('/view', '/preview');
  document.getElementById('outLink').href = url;
  document.getElementById('sheetOverlay').style.display = 'block';
  window.history.pushState({modal: true}, "");
  setTimeout(() => document.getElementById('docSheet').classList.add('active'), 10);
}

function closeSheet() {
  if (!sheetActive) return;
  sheetActive = false;
  document.getElementById('docSheet').classList.remove('active');
  setTimeout(() => { 
    document.getElementById('sheetOverlay').style.display = 'none'; 
    document.getElementById('sheetFrame').src = '';
  }, 300);
}

function goBack() { if (sheetActive) window.history.back(); }
window.addEventListener('popstate', closeSheet);
document.getElementById('sheetOverlay').onclick = goBack;
document.getElementById("dateFilter").addEventListener("change", renderUI);
document.getElementById("areaFilter").addEventListener("change", renderUI);
document.getElementById("searchInput").addEventListener("input", renderUI);
start();
</script>
</body>
</html>

